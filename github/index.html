<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>CONTATTI K2025 PVC FREE – by TPV Compound</title>
<link href="./manifest.webmanifest" rel="manifest"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="./env.js"></script>
<style>
    :root { --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --accent:#22c55e; --ring:#38bdf8; --text:#e5e7eb; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 1200px at 20% -5%, #0ea5e910, transparent 60%),radial-gradient(1400px 1400px at 120% 10%, #22c55e10, transparent 50%),var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0f172acc);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #111827}
    .nav{display:flex;align-items:center;gap:12px;padding:10px 14px;max-width:1200px;margin:0 auto}
    .logo img{height:36px}
    .brand{display:flex;flex-direction:column}
    .brand h1{font-size:18px;line-height:1.1;margin:0;background:linear-gradient(90deg,#e5e7eb,#93c5fd,#6ee7b7);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800}
    .brand small{color:#9ca3af;font-weight:600}
    .nav-actions{margin-left:auto;display:flex;align-items:center;gap:10px}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:8px 12px;border-radius:12px;border:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,#0b1220);color:#e5e7eb;cursor:pointer;font-weight:600;transition:transform .04s ease,filter .2s ease,box-shadow .2s ease}
    .btn:hover{filter:brightness(1.12)} .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(180deg,#22c55e,#16a34a);color:#07110a;border-color:#16a34a;box-shadow:0 6px 20px #22c55e33}
    .btn-outline{background:transparent;border-color:#334155;color:#cbd5e1}
    .container{padding:16px;max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(12,1fr)}
    .card{background:linear-gradient(180deg,#0b1220,#0b1220f0);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px #0006}
    .card-pad{padding:16px}
    .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    @media (max-width:900px){.col-6,.col-4,.col-3{grid-column:span 12}}
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
    input[type="text"],input[type="email"],select,textarea{width:100%;background:#0a0f1d;color:var(--text);border:1px solid #1e293b;border-radius:10px;padding:11px 12px;outline:none;transition:all .2s ease;box-shadow:0 1px 0 #000 inset}
    input[type="text"]:focus,input[type="email"]:focus,select:focus,textarea:focus{border-color:var(--ring);box-shadow:0 0 0 3px #38bdf833}
    textarea{min-height:80px;resize:vertical}
    .tools{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .table-wrap{margin-top:12px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:10px 8px;text-align:left;vertical-align:top;font-size:14px}
    th{color:#cbd5e1;font-weight:700;position:sticky;top:0;background:#0b1220}
    tr:hover td{background:#0b1220bb}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #334155;color:#a5b4fc}
    .muted{color:var(--muted)}
    .gate{position:fixed;inset:0;display:none;place-items:center;z-index:100;background:radial-gradient(1200px 1200px at 20% -5%, #0ea5e944, transparent 60%),radial-gradient(1400px 1400px at 120% 10%, #22c55e44, transparent 50%),var(--bg)}
    .gate.open{display:grid}
    .box{width:min(520px,92vw);background:linear-gradient(180deg,#0b1220,#0b1220f0);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 20px 60px #0007}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid #334155;cursor:pointer}
    .tab.active{background:#0b1220;border-color:#22c55e;color:#22c55e}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #334155}
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:20px;background:#000a}
    .modal.open{display:grid}
    .modal-card{background:#0b1220;border:1px solid #1f2937;border-radius:16px;padding:16px;max-width:900px;width:100%;max-height:80vh;overflow:auto;box-shadow:0 30px 80px #0008}
    .modal .thumb{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
    .modal .thumb img{width:160px;height:160px;border-radius:10px;border:1px solid #334155;object-fit:cover}
    .right{text-align:right}
  </style>
</head>
<body>
<!-- Password gate -->
<div class="gate" id="gate">
<div class="box">
<div class="logo" style="margin-bottom:8px;display:flex;gap:10px;align-items:center">
<img alt="TPV logo" src="./assets/logo.png"/>
<div class="brand"><h1>CONTATTI K2025 PVC FREE</h1><small>by TPV Compound</small></div>
</div>
<p class="muted">Inserisci la password per accedere.</p>
<input id="sharedPw" placeholder="Password" type="password"/>
<div style="display:flex;gap:10px;margin-top:10px">
<button class="btn btn-primary" onclick="gateUnlock()">Accedi</button>
<button class="btn btn-outline" onclick="document.getElementById('sharedPw').value='';document.getElementById('sharedPw').focus()">Cancella</button>
</div>
</div>
</div>
<header>
<div class="nav">
<div class="logo"><img alt="TPV logo" src="./assets/logo.png"/></div>
<div class="brand"><h1>CONTATTI K2025 PVC FREE</h1><small>by TPV Compound</small></div>
<div class="nav-actions">
<button class="btn btn-primary" onclick="scrollToForm(true)">＋ Nuovo contatto</button>
</div>
</div>
<div class="nav" style="padding-top:0">
<div class="tabs">
<div class="tab active" id="tab-contacts" onclick="switchTab('contacts')">Contatti</div>
<a class="tab" href="./database.html" id="tab-materials">Database Materiali</a>
</div>
</div>
</header>
<main class="container">
<!-- AUTH -->
<section class="card card-pad" id="auth">
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
<div>
<div style="font-weight:700">Accesso</div>
<div class="muted">Accedi con credenziali Supabase (email + password).</div>
</div>
<div class="muted" id="authStatus">Non autenticato</div>
</div>
<div class="grid" style="margin-top:8px">
<div class="col-4">
<label>Email</label>
<input id="auth_email" placeholder="nome@azienda.it" type="email"/>
</div>
<div class="col-4">
<label>Password</label>
<input id="auth_password" placeholder="Password" type="password"/>
</div>
<div class="col-4" style="display:flex;align-items:end;gap:10px">
<button class="btn btn-primary" onclick="login()">Login</button>
<button class="btn btn-outline" onclick="logout()">Logout</button>
</div>
</div>
</section>
<!-- CONTACTS VIEW -->
<section id="view-contacts">
<!-- FORM -->
<div class="card card-pad" id="formCard">
<div class="grid">
<div class="col-4">
<label>Nome</label>
<input id="nome" placeholder="Nome" type="text"/>
</div>
<div class="col-4">
<label>Cognome</label>
<input id="cognome" placeholder="Cognome" type="text"/>
</div>
<div class="col-4">
<label>Azienda</label>
<input id="azienda" placeholder="Azienda" type="text"/>
</div>
<div class="col-4">
<label>Email (obbligatoria)</label>
<input id="email" placeholder="email@azienda.it" type="email"/>
</div>
<div class="col-3">
<label>Categoria</label>
<select id="categoria">
<option disabled="" selected="" value="">Seleziona…</option>
<option>Cliente</option>
<option>Fornitore</option>
<option>Altro</option>
</select>
</div>
<div class="col-3">
<label>Regione commerciale</label>
<select id="regione">
<option disabled="" selected="" value="">Seleziona…</option>
<option>ITALIA</option>
<option>EMEA (esclusa Italia)</option>
<option>AMERICAS</option>
<option>APAC</option>
<option>CINA</option>
<option>INDIA</option>
<option>GIAPPONE / KOREA</option>
<option>ALTRO</option>
</select>
</div>
<div class="col-3">
<label>Polimero PVC free</label>
<select id="polimero">
<option disabled="" selected="" value="">Seleziona…</option>
<option>TPE</option>
<option>TPO</option>
<option>TPU</option>
<option>BIO</option>
</select>
</div>
<div class="col-3">
<label>Processo</label>
<select id="processo">
<option disabled="" selected="" value="">Seleziona…</option>
<option>Stampaggio</option>
<option>Estrusione</option>
<option>Altro</option>
</select>
</div>
<div class="col-12">
<label>Note</label>
<textarea id="note" placeholder="Note, richieste specifiche, applicazioni…"></textarea>
</div>
<div class="col-12">
<label>Immagini (solo formati immagine)</label>
<input accept="image/*" id="images" multiple="" type="file"/>
<div class="thumbs" id="imageThumbs"></div>
</div>
<div class="col-12" style="display:flex;gap:10px;flex-wrap:wrap">
<button class="btn btn-primary" onclick="addContatto()">Aggiungi contatto</button>
<button class="btn btn-outline" onclick="resetForm()">Reset modulo</button>
</div>
</div>
</div>
<!-- TOOLS -->
<div class="tools">
<button class="btn" onclick="exportXLSX()">Scarica Excel (.xlsx)</button>
<button class="btn btn-outline" onclick="loadRows()">Aggiorna tabella</button>
<button class="btn btn-outline" onclick="if(confirm('Sicuro di voler cancellare TUTTO?')){ clearAll(); }">Cancella TUTTI i contatti</button>
</div>
<!-- TABLE -->
<div class="table-wrap card card-pad">
<table id="tab">
<thead>
<tr>
<th>#</th>
<th>Nome</th>
<th>Cognome</th>
<th>Azienda</th>
<th>Email</th>
<th>Categoria</th>
<th>Regione</th>
<th>Polimero</th>
<th>Processo</th>
<th>Note</th>
<th>Immagini</th>
<th>Creato da</th>
<th>Azioni</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</section>
<!-- MATERIALS VIEW -->
<section id="view-materials" style="display:none">
<div class="card card-pad">
<div class="grid">
<div class="col-3">
<label>Categoria materiale</label>
<select id="matCat" onchange="loadMaterials()">
<option value="">Tutte</option>
<option value="TPE">TPE</option>
<option value="TPO">TPO</option>
<option value="TPU">TPU</option>
<option value="BIO">BIO</option>
</select>
</div>
<div class="col-9" style="display:flex;align-items:end">
<div class="muted">Libreria tecnica: filtra per categoria per vedere i materiali disponibili.</div>
</div>
</div>
</div>
<div class="card card-pad">
<table id="matTable" style="width:100%">
<thead><tr><th>#</th><th>Categoria</th><th>Nome</th><th>Descrizione</th></tr></thead>
<tbody id="matBody"></tbody>
</table>
</div>
</section>
<div class="muted" style="text-align:center;margin:18px 0">© 2025 – K2025 | by TPV Compound</div>
</main>
<!-- MODAL IMMAGINI -->
<div aria-labelledby="modalTitle" aria-modal="true" class="modal" id="modal" role="dialog">
<div class="modal-card">
<div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
<h3 id="modalTitle">Immagini contatto</h3>
<button class="btn btn-outline" onclick="closeModal()">Chiudi</button>
</div>
<div class="thumbs" id="modalBody" style="margin-top:10px;gap:14px"></div>
</div>
</div>
<script>
  // ============ PWA SW ============
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }

  // ============ STATE ============
  let supabaseClient;
  let currentUser = null;
  let data = [];
  let imagesBuf = [];

  // ============ HELPERS ============
  function short(s, n=80){ s=String(s||''); return s.length>n ? s.slice(0,n-1)+'…' : s; }
  function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function validEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim()); }
  function clearTable(){ document.getElementById('tbody').innerHTML=''; }

  // ============ UI NAV ============
  function switchTab(which){
    document.getElementById('tab-contacts').classList.toggle('active', which==='contacts');
    document.getElementById('tab-materials').classList.toggle('active', which==='materials');
    document.getElementById('view-contacts').style.display = which==='contacts' ? '' : 'none';
    document.getElementById('view-materials').style.display = which==='materials' ? '' : 'none';
    if (which==='materials') loadMaterials();
  }
  function scrollToForm(reset){
    if (reset) resetForm();
    document.getElementById('formCard').scrollIntoView({ behavior:'smooth', block:'start' });
    document.getElementById('nome').focus();
  }

  // ============ GATE ============
  function gateUnlock(){
    const pw = document.getElementById('sharedPw').value.trim();
    if (pw === (window.ENV?.SHARED_PASSWORD||'')) {
      sessionStorage.setItem('k2025_gate','ok');
      document.getElementById('gate').classList.remove('open');
    } else { alert('Password errata'); }
  }
  function setupGate(){
    const useGate = !!window.ENV?.USE_SHARED_PASSWORD;
    const ok = sessionStorage.getItem('k2025_gate') === 'ok';
    const gate = document.getElementById('gate');
    if (useGate && !ok) gate.classList.add('open');
  }

  // ============ SUPABASE ============
  function initSupabase(){
    if (!window.ENV) { alert('env.js mancante'); return; }
    supabaseClient = window.supabase.createClient(ENV.SUPABASE_URL, ENV.SUPABASE_ANON_KEY);
    supabaseClient.auth.onAuthStateChange((_event, session) => {
      currentUser = session?.user || null;
      document.getElementById('authStatus').textContent = currentUser ? ('Autenticato: ' + currentUser.email) : 'Non autenticato';
      if (currentUser) loadRows(); else clearTable();
    });
  }
  async function login(){
    if (!supabaseClient) initSupabase();
    const email = document.getElementById('auth_email').value.trim();
    const password = document.getElementById('auth_password').value.trim();
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) alert('Login fallito: ' + error.message);
  }
  async function logout(){ await supabaseClient.auth.signOut(); }

  // ============ FORM ============
  function resetForm(){
    ['nome','cognome','azienda','email','note'].forEach(id => document.getElementById(id).value='');
    ['categoria','regione','polimero','processo'].forEach(id => document.getElementById(id).selectedIndex=0);
    imagesBuf = []; document.getElementById('images').value = ''; document.getElementById('imageThumbs').innerHTML = '';
  }

  document.getElementById('images').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    imagesBuf = [];
    const wrap = document.getElementById('imageThumbs'); wrap.innerHTML='';
    for (const f of files){
      if(!f.type.startsWith('image/')) { alert('Sono ammessi solo file immagine.'); continue; }
      const dataUrl = await new Promise((res, rej) => { const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
      imagesBuf.push({ name: f.name, file: f, preview: dataUrl });
      const el = document.createElement('img'); el.src = dataUrl; el.title = f.name; wrap.appendChild(el);
    }
  });

  // ============ CRUD: CONTATTI ============
  async function addContatto(){
    if(!currentUser){ alert('Devi essere autenticato.'); return; }
    const entryBase = {
      nome: document.getElementById('nome').value.trim(),
      cognome: document.getElementById('cognome').value.trim(),
      azienda: document.getElementById('azienda').value.trim(),
      email: document.getElementById('email').value.trim(),
      categoria: document.getElementById('categoria').value,
      regione: document.getElementById('regione').value,
      polimero: document.getElementById('polimero').value,
      processo: document.getElementById('processo').value,
      note: document.getElementById('note').value.trim(),
      images: []
    };
    if(!entryBase.nome || !entryBase.cognome || !entryBase.azienda){ alert('Nome, Cognome e Azienda sono obbligatori.'); return; }
    if(!validEmail(entryBase.email)){ alert('Email non valida (obbligatoria).'); return; }

    // Inserimento con created_by (fallback se cache non aggiornata)
    let payload = { ...entryBase, created_by: currentUser?.email || null };
    let ins = await supabaseClient.from('contacts').insert(payload).select().single();
    if (ins.error && /created_by/i.test(ins.error.message || '')) {
      payload = { ...entryBase };
      ins = await supabaseClient.from('contacts').insert(payload).select().single();
    }
    if (ins.error){ alert('Errore salvataggio: ' + ins.error.message); return; }

    const id = ins.data.id;

    // Upload immagini
    const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
    const uploaded = [];
    for (const img of imagesBuf){
      const ext = (img.file.name.split('.').pop() || 'jpg').toLowerCase();
      const path = `contact-${id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
      const { error: upErr } = await supabaseClient.storage.from(bucket).upload(path, img.file, { upsert: true, contentType: img.file.type });
      if (!upErr) uploaded.push({ name: img.name, path });
    }
    if (uploaded.length){
      const { error: updErr } = await supabaseClient.from('contacts').update({ images: uploaded }).eq('id', id);
      if (updErr) alert('Immagini caricate ma non salvate in tabella: ' + updErr.message);
    }

    resetForm();
    await loadRows();
  }

  async function loadRows(){
    const { data: rows, error } = await supabaseClient.from('contacts').select('*').order('created_at',{ascending:false});
    if (error){ alert('Errore caricamento: ' + (error.message || JSON.stringify(error))); return; }
    data = rows || [];
    render();
  }

  function render(){
    const tb = document.getElementById('tbody'); tb.innerHTML = '';
    (data || []).forEach((r, i) => {
      const imgCount = (r.images || []).length;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHTML(r.nome||'')}</td>
        <td>${escapeHTML(r.cognome||'')}</td>
        <td>${escapeHTML(r.azienda||'')}</td>
        <td>${escapeHTML(r.email||'')}</td>
        <td><span class="badge">${escapeHTML(r.categoria||'')}</span></td>
        <td>${escapeHTML(r.regione||'')}</td>
        <td>${escapeHTML(r.polimero||'')}</td>
        <td>${escapeHTML(r.processo||'')}</td>
        <td title="${escapeHTML(r.note||'')}">${escapeHTML(short(r.note||'', 60))}</td>
        <td><button class="btn btn-outline" onclick="viewImgs(${r.id})">${imgCount ? '📷 ' + imgCount : '＋ Aggiungi'}</button></td>
        <td>${escapeHTML(r.created_by||'')}</td>
        <td class="right">
          <button class="btn btn-outline" onclick="addImgsToRow(${r.id})">Aggiungi img</button>
          <button class="btn btn-outline" onclick="delRow(${r.id})">Elimina</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  async function delRow(id){
    if(!confirm('Eliminare questa riga e le sue immagini?')) return;
    const row = (data||[]).find(r => r.id === id);
    if (row?.images?.length){
      const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
      const paths = row.images.map(x => x.path);
      await supabaseClient.storage.from(bucket).remove(paths);
    }
    const { error } = await supabaseClient.from('contacts').delete().eq('id', id);
    if (error) alert('Errore eliminazione: ' + error.message);
    await loadRows();
  }

  async function addImgsToRow(id){
    if(!currentUser){ alert('Devi essere autenticato.'); return; }
    const hidden = document.createElement('input');
    hidden.type = 'file'; hidden.accept = 'image/*'; hidden.multiple = true; hidden.style.display='none';
    hidden.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      const row = (data||[]).find(r => r.id === id); if(!row) return;
      const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
      const newImgs = [];
      for (const f of files){
        if(!f.type.startsWith('image/')) continue;
        const ext = (f.name.split('.').pop() || 'jpg').toLowerCase();
        const path = `contact-${id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
        const { error: upErr } = await supabaseClient.storage.from(bucket).upload(path, f, { upsert: true, contentType: f.type });
        if(!upErr) newImgs.push({ name: f.name, path });
      }
      const merged = (row.images||[]).concat(newImgs);
      const { error: updErr } = await supabaseClient.from('contacts').update({ images: merged }).eq('id', id);
      if (updErr) alert('Immagini caricate ma non salvate in tabella: ' + updErr.message);
      await loadRows();
    });
    document.body.appendChild(hidden); hidden.click(); setTimeout(()=>hidden.remove(), 500);
  }

  async function viewImgs(id){
    const row = (data||[]).find(r => r.id === id);
    const modal = document.getElementById('modal');
    const body = document.getElementById('modalBody'); body.innerHTML = '';
    if (row && Array.isArray(row.images) && row.images.length){
      const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
      for (const img of row.images){
        const { data: signed } = await supabaseClient.storage.from(bucket).createSignedUrl(img.path, 300);
        const wrap = document.createElement('div'); wrap.className = 'thumb'; wrap.style.display='inline-flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='flex-start'; wrap.style.gap='6px';
        const el = document.createElement('img'); el.src = signed?.signedUrl || ''; el.alt = img.name; el.style.width='160px'; el.style.height='160px'; el.style.objectFit='cover'; el.style.border='1px solid #334155'; el.style.borderRadius='10px';
        const a = document.createElement('a'); a.href = signed?.signedUrl || '#'; a.download = img.name; a.className='btn btn-outline'; a.textContent='Scarica';
        const del = document.createElement('button'); del.className='btn btn-outline'; del.textContent='Elimina';
        del.onclick = async () => { await deleteSingleImage(id, img.path); viewImgs(id); };
        wrap.appendChild(el); wrap.appendChild(a); wrap.appendChild(del);
        body.appendChild(wrap);
      }
    } else {
      body.innerHTML = '<p class="muted">Nessuna immagine.</p>';
    }
    modal.classList.add('open');
  }
  async function deleteSingleImage(id, path){
    const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
    await supabaseClient.storage.from(bucket).remove([path]);
    const row = (data||[]).find(r => r.id === id);
    const remaining = (row.images||[]).filter(x => x.path !== path);
    await supabaseClient.from('contacts').update({ images: remaining }).eq('id', id);
    await loadRows();
  }
  function closeModal(){ document.getElementById('modal').classList.remove('open'); }

  // ============ MATERIALS ============
  async function loadMaterials(){
    const cat = document.getElementById('matCat').value;
    let query = supabaseClient.from('materials').select('id,categoria,nome,descrizione').order('created_at',{ascending:false});
    if (cat) query = query.eq('categoria',cat);
    const { data: rows, error } = await query;
    if (error){ alert('Errore materiali: ' + (error.message || JSON.stringify(error))); return; }
    const body = document.getElementById('matBody'); body.innerHTML = '';
    (rows||[]).forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHTML(r.categoria||'')}</td><td>${escapeHTML(r.nome||'')}</td><td>${escapeHTML(r.descrizione||'')}</td>`;
      body.appendChild(tr);
    });
  }

  // ============ EXPORT ============
  function exportXLSX(){
    if (typeof XLSX === 'undefined'){ alert('Export non disponibile.'); return; }
    const rows = (data||[]).map((r, i) => ({
      "#": i+1,
      "Nome": r.nome || "",
      "Cognome": r.cognome || "",
      "Azienda": r.azienda || "",
      "Email": r.email || "",
      "Categoria": r.categoria || "",
      "Regione": r.regione || "",
      "Polimero": r.polimero || "",
      "Processo": r.processo || "",
      "Note": r.note || "",
      "Immagini (n°)": (r.images||[]).length,
      "Creato da": r.created_by || "",
      "Creato il": r.created_at || ""
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Contatti");
    XLSX.writeFile(wb, "Contatti_K2025_PVC_FREE.xlsx");
  }

  // ============ CLEAR ALL ============
  async function clearAll(){
    if(!currentUser){ alert('Devi essere autenticato.'); return; }
    if(!confirm('Eliminare TUTTI i contatti e le relative immagini?')) return;

    const { data: rows, error } = await supabaseClient.from('contacts').select('id, images');
    if (error) { alert('Errore caricamento: ' + error.message); return; }

    const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
    for (const r of rows || []) {
      if (Array.isArray(r.images) && r.images.length) {
        const paths = r.images.map(x => x.path);
        await supabaseClient.storage.from(bucket).remove(paths);
      }
    }
    const { error: delErr } = await supabaseClient.from('contacts').delete().neq('id', -1);
    if (delErr) { alert('Errore eliminazione: ' + delErr.message); return; }
    await loadRows();
    alert('Tutti i contatti sono stati eliminati.');
  }

  // ============ EXPOSE TO WINDOW (fix onclick) ============
  window.switchTab = switchTab;
  window.scrollToForm = scrollToForm;
  window.gateUnlock = gateUnlock;
  window.login = login;
  window.logout = logout;
  window.addContatto = addContatto;
  window.loadRows = loadRows;
  window.delRow = delRow;
  window.addImgsToRow = addImgsToRow;
  window.viewImgs = viewImgs;
  window.closeModal = closeModal;
  window.exportXLSX = exportXLSX;
  window.clearAll = clearAll;

  // ============ INIT ============
  window.addEventListener('DOMContentLoaded', () => {
    setupGate();
    initSupabase();
  });
</script>
</body>
</html>
