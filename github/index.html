<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PVC-FREE K2025 contatti e database</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .table-sticky thead th { position: sticky; top: 0; background: #0f172a; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <header class="border-b border-slate-800 p-4 flex items-center gap-4">
    <h1 class="text-lg font-bold">PVC-FREE K2025 contatti e database</h1>
    <nav class="ml-auto flex gap-2">
      <button id="btnContatti" class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700">Contatti</button>
      <button id="btnDatabase" class="px-3 py-1 rounded bg-emerald-600 text-slate-900 font-semibold">Database Materiali</button>
    </nav>
    <a href="#" class="ml-2 px-3 py-1 rounded bg-emerald-500 text-slate-900 font-semibold">+ Nuovo contatto</a>
  </header>

  <main class="max-w-7xl mx-auto p-4">
    <section id="databaseView">
      <h2 class="text-xl font-semibold">Database Materiali — scegli tra i materiali a disposizione</h2>
      <div class="mt-4 flex flex-wrap gap-4 items-end">
        <div>
          <label class="text-sm">Tipologia polimero</label>
          <select id="fTipo" class="block mt-1 bg-slate-900 border border-slate-700 rounded px-2 py-1">
            <option value="">Tutte</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Applicazione</label>
          <select id="fApp" class="block mt-1 bg-slate-900 border border-slate-700 rounded px-2 py-1">
            <option value="">Tutte</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Durezza min</label>
          <input id="fMin" type="number" value="0" class="block mt-1 w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1" />
        </div>
        <div>
          <label class="text-sm">Durezza max</label>
          <input id="fMax" type="number" value="100" class="block mt-1 w-20 bg-slate-900 border border-slate-700 rounded px-2 py-1" />
        </div>
        <button id="btnApply" class="px-3 py-1 rounded bg-emerald-600 text-slate-900 font-semibold">Applica</button>
        <button id="btnReset" class="px-3 py-1 rounded bg-slate-800">Reset</button>
        <button id="btnExport" class="px-3 py-1 rounded border border-slate-700">Esporta CSV</button>
      </div>
      <div class="mt-2 text-sm text-slate-400">
        <span id="count">0 risultati</span>
        <span> • Sorgente: <code id="srcPath">./data/materiali_database.csv</code></span>
      </div>
      <div class="mt-4 overflow-auto border border-slate-800 rounded">
        <table class="min-w-full text-sm" id="tbl">
          <thead>
            <tr>
              <th class="px-3 py-2">Sigla</th>
              <th class="px-3 py-2">Processo</th>
              <th class="px-3 py-2">regulation</th>
              <th class="px-3 py-2">Peso Specifico (g/cm3) ISO 1183-1</th>
              <th class="px-3 py-2">Carico di Rottura (N/mm2) ISO 527</th>
              <th class="px-3 py-2">Allungamento a Rottura (N/mm2) ISO 527</th>
              <th class="px-3 py-2">Compression Set (ASTM D 395) (22°C/72h)</th>
              <th class="px-3 py-2">special features</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const CSV_PATH = './data/materiali_database.csv';
    let rawData = [];

    function normalizeRow(row){
      const out = {};
      for(const k in row){
        const key = k.trim();
        let val = row[k];
        if(typeof val === 'string'){
          val = val.trim();
          if(/^\d+(,\d+)?$/.test(val)){
            val = Number(val.replace(',', '.'));
          }
        }
        out[key] = val;
      }
      return out;
    }

    async function loadCsv(){
      document.getElementById('srcPath').textContent = CSV_PATH;
      const resp = await fetch(CSV_PATH);
      const text = await resp.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      rawData = parsed.data.map(normalizeRow);
      drawTable(rawData);
      buildFilters();
    }

    function buildFilters(){
      const tipi = [...new Set(rawData.map(r => r['Tipologia polimero']).filter(Boolean))];
      const apps = [...new Set(rawData.map(r => r['Applicazione']).filter(Boolean))];
      fillSelect('fTipo', tipi);
      fillSelect('fApp', apps);
    }

    function fillSelect(id, values){
      const sel = document.getElementById(id);
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    function applyFilters(){
      const tipo = document.getElementById('fTipo').value;
      const app = document.getElementById('fApp').value;
      const min = Number(document.getElementById('fMin').value);
      const max = Number(document.getElementById('fMax').value);
      const filtered = rawData.filter(r => {
        const duro = Number(r['Durezza']||0);
        return (!tipo || r['Tipologia polimero']===tipo)
          && (!app || r['Applicazione']===app)
          && (duro>=min && duro<=max);
      });
      drawTable(filtered);
    }

    function drawTable(rows){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      document.getElementById('count').textContent = rows.length + ' risultati';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${r['Sigla']||''}</td>
          <td class="px-3 py-2">${r['Processo']||''}</td>
          <td class="px-3 py-2">${r['regulation']||''}</td>
          <td class="px-3 py-2">${r['Peso Specifico (g/cm3) ISO 1183-1']||''}</td>
          <td class="px-3 py-2">${r['Carico di Rottura (N/mm2) ISO 527']||''}</td>
          <td class="px-3 py-2">${r['Allungamento a Rottura (N/mm2) ISO 527']||''}</td>
          <td class="px-3 py-2">${r['Compression Set (ASTM D 395) (22°C/72h)']||''}</td>
          <td class="px-3 py-2">${r['special features']||''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function exportCsv(){
      const csv = Papa.unparse(rawData);
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'materiali_export.csv';
      a.click();
    }

    document.getElementById('btnApply').addEventListener('click', applyFilters);
    document.getElementById('btnReset').addEventListener('click', () => drawTable(rawData));
    document.getElementById('btnExport').addEventListener('click', exportCsv);

    loadCsv();
  </script>
</body>
</html>
