<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PVC-FREE K2025 contatti e database</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{--bg:#0c0f16;--panel:#121724;--muted:#9aa3b2;--text:#e8ecf4;--brand:#6aa5ff;--ok:#17c964;--warn:#ffaa00}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab-btn{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0f1322;color:var(--text);cursor:pointer}
    .tab-btn.active{background:var(--brand);color:#0b0d12;border-color:var(--brand)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select,.field textarea{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#121724;color:var(--text)}
    .btn{padding:10px 14px;border-radius:12px;border:0;background:var(--brand);color:#0b0d12;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1b2135;color:var(--text);border:1px solid rgba(255,255,255,.12)}
    .btn.warn{background:var(--warn);color:#0b0d12}
    .muted{color:var(--muted)}
    .section{display:none}
    .section.active{display:block}
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.08);margin-top:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#11152a;text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.08);white-space:nowrap}
    tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px;vertical-align:top}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .pill{background:#1a2138;color:var(--text);border:1px solid rgba(255,255,255,.12);padding:2px 8px;border-radius:999px;font-size:12px}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PVCFree</h1>
    <div class="tabs">
      <button class="tab-btn active" data-tab="contatti">Contatti</button>
      <button class="tab-btn" data-tab="db">Database Materiali</button>
      <a class="tab-btn" href="contatti-admin.html" target="_blank" rel="noopener">Admin (ðŸ“Ž & Excel)</a>
    </div>

    <!-- ================== CONTATTI ================== -->
    <section id="contatti" class="section active">
      <div class="card">
        <h2>Nuovo contatto</h2>
        <p class="muted">Compila e premi <strong>Aggiungi contatto</strong>. VerrÃ  salvato nella tabella qui sotto e inviato anche a Netlify Forms (per gestire gli allegati e l'export Excel).</p>
        <div class="grid" style="margin-top:8px">
          <div class="field" style="grid-column: span 4;">
            <label for="azienda">Azienda</label>
            <input id="azienda" placeholder="Ragione sociale">
          </div>
          <div class="field" style="grid-column: span 4;">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="nome@azienda.com">
          </div>
          <div class="field" style="grid-column: span 4;">
            <label for="categoria">Categoria</label>
            <select id="categoria">
              <option>Cliente</option>
              <option>Fornitore</option>
              <option>Partner</option>
              <option>Altro</option>
            </select>
          </div>

          <div class="field" style="grid-column: span 4;">
            <label for="regione">Regione / Paese</label>
            <input id="regione" placeholder="es. Lombardia / IT">
          </div>
          <div class="field" style="grid-column: span 4;">
            <label for="polimero">Polimero</label>
            <input id="polimero" placeholder="es. BIO / TPE-S">
          </div>
          <div class="field" style="grid-column: span 4;">
            <label for="processo">Processo</label>
            <input id="processo" placeholder="es. Stampaggio, Estrusioneâ€¦">
          </div>

          <div class="field" style="grid-column: span 12;">
            <label for="note">Note</label>
            <textarea id="note" rows="4" placeholder="Note, richieste specifiche, applicazioniâ€¦"></textarea>
          </div>

          <div class="field" style="grid-column: span 6;">
            <label for="immagini">Immagini (JPG/PNG/WEBP/GIF)</label>
            <input id="immagini" type="file" accept="image/*">
          </div>
        </div>

        <div class="tools">
          <button id="btn-add-contact" class="btn">Aggiungi contatto</button>
          <button id="btn-reset" class="btn secondary">Reset modulo</button>
          <!-- Aggiunto: Export Excel contatti -->
          <button id="btn-export-contacts" class="btn secondary">Esporta Excel</button>
        </div>

        <div class="table-wrap">
          <table id="tbl-contatti">
            <thead>
              <tr>
                <th>Azienda</th><th>Email</th><th>Categoria</th><th>Regione</th>
                <th>Polimero</th><th>Processo</th><th>Note</th><th>Immagine</th><th>Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ================== DATABASE MATERIALI ================== -->
    <section id="db" class="section">
      <div class="card">
        <h2>Database Materiali</h2> <span class="muted" style="margin-left:8px">â€” scegli tra i materiali a disposizione</span>
        <p class="muted">Filtra per <strong>Tipologia polimero</strong>, <strong>Applicazione</strong> e <strong>Durezza (ShA)</strong>. La tabella mostra le proprietÃ  principali.</p>

        <div class="grid" style="margin-top:8px">
          <div class="field" style="grid-column: span 4;">
            <label>Tipologia polimero</label>
            <select id="f-tipologia"><option value="">Tutte</option></select>
          </div>
          <div class="field" style="grid-column: span 4;">
            <label>Applicazione</label>
            <select id="f-app"><option value="">Tutte</option></select>
          </div>
          <div class="field" style="grid-column: span 4;">
            <label>Durezza (ShA) â€” intervallo</label>
            <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px">
              <input id="f-min" placeholder="min">
              <input id="f-max" placeholder="max">
            </div>
          </div>
        </div>

        <div class="tools">
          <button id="btn-apply" class="btn">Applica</button>
          <button id="btn-reset-db" class="btn secondary">Reset</button>
          <button id="btn-export-db" class="btn secondary">Esporta CSV</button>
          <span id="db-meta" class="muted" style="align-self:center"></span>
        </div>

        <div class="table-wrap">
          <table id="tbl-db">
            <thead>
              <tr>
                <th>Sigla</th><th>Processo</th><th>regulation</th>
                <th>Peso Specifico (g/cm3) ISO 1183-1</th>
                <th>Carico di Rottura (N/mm2) ISO 527</th>
                <th>Allungamento a Rottura (N/mm2) ISO 527</th>
                <th>Compression Set (ASTM D 395) (22Â°C/72h)</th>
                <th>special features</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- ====== Form "fantasma" per Netlify (rilevamento + upload) ====== -->
  <form id="nl-contatti" name="contatti"
        method="POST" data-netlify="true"
        netlify-honeypot="bot-field"
        enctype="multipart/form-data" hidden>
    <input type="hidden" name="form-name" value="contatti">
    <!-- campi verranno compilati via JS -->
    <input type="text"   name="nome"      hidden>
    <input type="email"  name="email"     hidden>
    <textarea name="messaggio"            hidden></textarea>
    <!-- l'allegato lo inviamo con fetch/FormData -->
  </form>

  <script>
  // ====== Tabs
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click',()=>{
      const tab=b.dataset.tab; if(!tab) return;
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      b.classList.add('active'); document.getElementById(tab).classList.add('active');
    });
  });

  // ====== CONTATTI (tab)
  const qs = s=>document.querySelector(s);
  const $tbodyContatti = qs('#tbl-contatti tbody');

  // Nuovo: dataset locale per export e id riga
  let CONTACT_SEQ = 0;
  const contactsData = []; // {id, azienda,email,categoria,regione,polimero,processo,note,imgName,images?}

  function addRowContatto(row){
    const id = row.id || (++CONTACT_SEQ);
    row.id = id;
    // salva/aggiorna in dataset
    const idx = contactsData.findIndex(r=>r.id===id);
    if (idx >= 0) contactsData[idx] = row; else contactsData.push(row);

    const tr=document.createElement('tr');
    tr.dataset.id = String(id);
    tr.innerHTML = \`
      <td>\${row.azienda||''}</td>
      <td>\${row.email||''}</td>
      <td>\${row.categoria||''}</td>
      <td>\${row.regione||''}</td>
      <td>\${row.polimero||''}</td>
      <td>\${row.processo||''}</td>
      <td>\${(row.note||'').replace(/</g,'&lt;')}</td>
      <td>\${row.imgName? \`<span class="pill">\${row.imgName}</span>\`:'â€”'}</td>
      <td class="right">
        <button class="btn secondary" onclick="addImgsToRow(\${id}, this)">Aggiungi img</button>
        <button class="btn secondary" style="border-color:#dc2626;color:#fecaca" onclick="deleteContatto(\${id}, this)">Elimina</button>
      </td>\`;
    $tbodyContatti.prepend(tr);
  }

  async function inviaA_Netlify({ nome, email, messaggio, file }) {
    try {
      // compilo anche gli input del form fantasma (facoltativo ma utile)
      const frm = document.getElementById('nl-contatti');
      frm.querySelector('input[name="nome"]').value = nome || '';
      frm.querySelector('input[name="email"]').value = email || '';
      frm.querySelector('textarea[name="messaggio"]').value = messaggio || '';

      // invio via fetch con FormData (cosÃ¬ includo file)
      const fd = new FormData(frm);
      if (file) fd.append('allegato', file);
      await fetch('/', { method: 'POST', body: fd });
      console.log('Inviato a Netlify');
    } catch (e) { console.error('Netlify form error:', e); }
  }

  // Semplice helper per aggiungere immagine a una riga (solo UI + dataset locale)
  window.addImgsToRow = function(id, btn){
    try{
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'image/*';
      input.onchange = () => {
        const file = input.files && input.files[0];
        if (!file) return;
        const row = contactsData.find(r=>r.id===id);
        if (row){ row.imgName = file.name; }
        // aggiorna cella UI
        const tr = btn.closest('tr');
        const pillCell = tr ? tr.querySelectorAll('td')[7] : null; // colonna Immagine
        if (pillCell){ pillCell.innerHTML = '<span class="pill">'+file.name+'</span>'; }
      };
      input.click();
    }catch(e){ console.error(e); }
  };

  // Eliminazione riga (UI locale) + hook per Supabase se presente
  window.deleteContatto = async function(id, btn){
    if(!confirm("Sei sicuro di voler eliminare questo contatto? Operazione irreversibile.")) return;
    try{
      // Hook opzionale Supabase: se esistessero id/immagini persistite
      const row = contactsData.find(r=>r.id===id) || null;
      const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
      if (row && window.supabaseClient && Array.isArray(row.images) && row.images.length){
        const paths = row.images.map(x => x.path).filter(Boolean);
        if (paths.length){
          const { error: delErr } = await supabaseClient.storage.from(bucket).remove(paths);
          if (delErr) console.warn("Eliminazione immagini fallita (continuo):", delErr.message);
        }
      }
      if (row && window.supabaseClient && row.supabase_id){
        const { error: delRowErr } = await supabaseClient.from('contacts').delete().eq('id', row.supabase_id);
        if (delRowErr) throw delRowErr;
      }

      // Rimuovi dal dataset e dal DOM
      const i = contactsData.findIndex(r=>r.id===id);
      if (i>=0) contactsData.splice(i,1);
      const tr = btn && btn.closest ? btn.closest('tr') : null;
      if (tr && tr.parentNode) tr.parentNode.removeChild(tr);

      alert("Contatto eliminato.");
    }catch(e){
      console.error(e);
      alert("Errore eliminazione: " + (e.message || e));
    }
  };

  qs('#btn-add-contact').addEventListener('click', async ()=>{
    const row = {
      azienda : qs('#azienda').value.trim(),
      email   : qs('#email').value.trim(),
      categoria: qs('#categoria').value,
      regione : qs('#regione').value.trim(),
      polimero: qs('#polimero').value.trim(),
      processo: qs('#processo').value.trim(),
      note    : qs('#note').value.trim(),
    };
    const file = qs('#immagini').files && qs('#immagini').files[0] ? qs('#immagini').files[0] : null;
    row.imgName = file ? file.name : '';

    // 1) aggiungo alla tabella locale (e dataset)
    addRowContatto(row);

    // 2) invio in parallelo a Netlify (per allegati + admin)
    await inviaA_Netlify({ nome: row.azienda, email: row.email, messaggio: row.note, file });

    // 3) reset campi base (lascia l'upload)
    // (se vuoi reset anche file, scommenta la riga)
    // qs('#immagini').value = '';
  });

  qs('#btn-reset').addEventListener('click', ()=>{
    ['azienda','email','regione','polimero','processo','note'].forEach(id=>qs('#'+id).value='');
    qs('#categoria').selectedIndex=0;
    qs('#immagini').value='';
  });

  // Export Excel contatti (con URL immagini se presente Supabase)
  window.exportXLSX = async function(){
    try{}catch(e){}
    const bucket = (window.ENV && window.ENV.STORAGE_BUCKET) || 'contact-images';
    function imgUrls(arr){
      try{
        if (!window.supabaseClient) return "";
        return (arr||[])
          .map(x => supabaseClient.storage.from(bucket).getPublicUrl(x.path)?.data?.publicUrl)
          .filter(Boolean)
          .join("\n");
      }catch(e){ return ""; }
    }
    const rows = (contactsData||[]).map((r, i)=> ({
      "#": i+1,
      "Azienda": r.azienda||"",
      "Email": r.email||"",
      "Categoria": r.categoria||"",
      "Regione": r.regione||"",
      "Polimero": r.polimero||"",
      "Processo": r.processo||"",
      "Note": r.note||"",
      "Immagini (nÂ°)": Array.isArray(r.images) ? r.images.length : (r.imgName ? 1 : 0),
      "Immagini URL": Array.isArray(r.images) ? imgUrls(r.images) : "",
      "Creato il": new Date().toISOString()
    }));
    if (typeof XLSX === 'undefined'){ alert('Export non disponibile (XLSX non caricato).'); return; }
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Contatti");
    XLSX.writeFile(wb, "Contatti_K2025_PVC_FREE.xlsx");
  };
  qs('#btn-export-contacts').addEventListener('click', exportXLSX);

  // ====== DATABASE MATERIALI
  const DB = { rows:[], headers:[], idx:{} };

  function parseCSV(text){
    // normalizza CRLF
    const lines = text.replace(/\r\n/g,'\n').split('\n').filter(l=>l.trim().length);
    // rimuovi eventuale riga "DATI di INPUT;...;DATI di OUTPUT..."
    if (/^ *DATI.+OUTPUT/i.test(lines[0])) lines.shift();

    const sep = ';'; // il tuo CSV usa ; come separatore
    const headers = lines[0].split(sep).map(h=>h.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = line.split(sep);
      const obj = {};
      headers.forEach((h,i)=>obj[h]= (cells[i]??'').trim());
      return obj;
    });
    return { headers, rows };
  }

  async function loadCSV(){
    const urls = [
      '/data/materiali_database.csv',
      './data/materiali_database.csv',
      'data/materiali_database.csv'
    ];
    let txt=null, used=null;
    for (const u of urls){
      try{
        const r = await fetch(\`\${u}?v=\${Date.now()}\`);
        if (r.ok){ txt = await r.text(); used = u; break; }
      }catch{}
    }
    if (!txt) throw new Error('CSV non trovato nelle path /data, ./data, data');
    console.log('CSV caricato da:', used);
    const {headers, rows} = parseCSV(txt);
    // mappa nomi colonne attese (adatta ai tuoi header reali)
    DB.headers = headers;
    DB.rows = rows.map(r=>{
      return {
        tipologia: r['Tipologia polimero']||'',
        applicazione: r['Applicazione']||'',
        durezza: (r['Durezza (ShA) - ISO 868']||'').replace(/[^\d.]/g,''),
        sigla: r['Sigla']||'',
        processo: r['Processo']||r['Processo ']||'',
        regulation: r['regulation']||'',
        densita: r['Peso Specifico (g/cm3) ISO 1183-1']||'',
        carico: r['Carico di Rottura (N/mm2) ISO 527']||'',
        allung: r['Allungamento a Rottura (N/mm2) ISO 527']||'',
        cset: r['Compression Set  (ASTM D 395) ( 22Â°C/72h)']||r['Compression Set (ASTM D 395) (22Â°C/72h)']||'',
        features: r['special features']||''
      };
    });
    buildFilters();
    renderDB(DB.rows);
  }

  function uniq(arr){ return [...new Set(arr.filter(Boolean))].sort(); }

  function buildFilters(){
    const tip = uniq(DB.rows.map(r=>r.tipologia));
    const app = uniq(DB.rows.map(r=>r.applicazione));
    const $tip = qs('#f-tipologia'), $app = qs('#f-app');
    tip.forEach(v=>{ const o=document.createElement('option'); o.value=v;o.textContent=v;$tip.appendChild(o); });
    app.forEach(v=>{ const o=document.createElement('option'); o.value=v;o.textContent=v;$app.appendChild(o); });
  }

  function renderDB(rows){
    const tb = qs('#tbl-db tbody'); tb.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = \`
        <td>\${r.sigla}</td>
        <td>\${r.processo}</td>
        <td>\${r.regulation}</td>
        <td>\${r.densita}</td>
        <td>\${r.carico}</td>
        <td>\${r.allung}</td>
        <td>\${r.cset}</td>
        <td>\${r.features}</td>\`;
      tb.appendChild(tr);
    });
    qs('#db-meta').textContent = \`\${rows.length} risultati\`;
  }

  // Nuovo: parser tollerante durezza
  function getHardnessValue(row){
    const keys = ["durezza","Durezza","hardness","Hardness","ShA","Shore A","Shore_A","shore_a","ShoreA"];
    let raw = "";
    for (const k of keys){
      if (row && row[k] != null && String(row[k]).trim() !== ""){
        raw = String(row[k]);
        break;
      }
    }
    if (!raw) raw = String(row && row.durezza || "").trim();
    if (!raw) return NaN;
    const m = raw.replace(",", ".").match(/(\d+(?:\.\d+)?)/);
    return m ? parseFloat(m[1]) : NaN;
  }

  // Sostituito: applyFilters con parser robusto
  function applyFilters(){
    const cat = (document.getElementById('f-tipologia')?.value || "").trim();
    const app = (document.getElementById('f-app')?.value || "").trim();
    const minStr = (document.getElementById('f-min')?.value || "").trim().replace(",", ".");
    const maxStr = (document.getElementById('f-max')?.value || "").trim().replace(",", ".");
    const min = minStr === "" ? -Infinity : parseFloat(minStr);
    const max = maxStr === "" ?  Infinity : parseFloat(maxStr);

    const filtered = (DB.rows || []).filter(r => {
      if (cat && String(r.tipologia||"") !== cat) return false;
      if (app && String(r.applicazione||"") !== app) return false;

      const hv = getHardnessValue(r);
      if (!isFinite(hv)) return (isFinite(min) || isFinite(max)) ? false : true;
      if (hv < min) return false;
      if (hv > max) return false;
      return true;
    });

    renderDB(filtered);
  }

  function exportCSV(rows){
    const headers = ['Sigla','Processo','regulation','Peso Specifico (g/cm3) ISO 1183-1','Carico di Rottura (N/mm2) ISO 527','Allungamento a Rottura (N/mm2) ISO 527','Compression Set (ASTM D 395) (22Â°C/72h)','special features'];
    const lines = [headers.join(';')].concat(rows.map(r=>[
      r.sigla,r.processo,r.regulation,r.densita,r.carico,r.allung,r.cset,r.features
    ].map(v=>String(v).replace(/;/g,',')).join(';')));
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='materiali_filtrati.csv'; a.click();
  }

  qs('#btn-apply').addEventListener('click', applyFilters);
  qs('#btn-reset-db').addEventListener('click', ()=>{
    ['#f-tipologia','#f-app','#f-min','#f-max'].forEach(s=>{ const el=qs(s); if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; });
    renderDB(DB.rows);
  });
  qs('#btn-export-db').addEventListener('click', ()=> exportCSV(Array.from(qs('#tbl-db tbody').children).map(tr=>{
    const tds = tr.querySelectorAll('td'); return {
      sigla: tds[0].textContent, processo: tds[1].textContent, regulation: tds[2].textContent,
      densita: tds[3].textContent, carico: tds[4].textContent, allung: tds[5].textContent,
      cset: tds[6].textContent, features: tds[7].textContent
    };
  })));

  // Trigger comodi per i range durezza
  ['f-min','f-max'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('keydown', e => { if (e.key === 'Enter') applyFilters(); });
    el.addEventListener('blur', applyFilters);
  });

  // INIT
  (async function init(){
    try { await loadCSV(); } 
    catch(e){ console.error(e); qs('#db-meta').textContent = 'Errore: ' + e.message; }
  })();
  </script>

<div id="gate" style="position:fixed;inset:0;display:grid;place-items:center;background:#0f172acc;backdrop-filter:blur(4px);z-index:9999">
  <div style="background:#0b1220;border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 20px 60px #0007;min-width:300px;max-width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
      <div style="display:flex;gap:10px;align-items:center">
        <img src="./assets/logo.png" alt="TPV" style="height:32px">
        <strong>PVC-FREE K2025 contatti e database</strong>
      </div>
      <img src="./assets/sft-polymer.png" alt="SFT Polymer" style="height:26px">
    </div>
    <div style="color:#94a3b8;margin-bottom:6px">Inserisci la password generale per entrare.</div>
    <input id="sharedPw" type="password" placeholder="Password" style="width:100%;background:#0a0f1d;color:#e5e7eb;border:1px solid #1e293b;border-radius:10px;padding:10px 12px;outline:none;">
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="gateBtn" class="btn btn-primary" style="flex:1">Accedi</button>
      <button id="gateClear" class="btn btn-outline">Cancella</button>
    </div>
    <div id="gateMsg" style="color:#f87171;margin-top:6px;font-size:12px"></div>
  </div>
</div>
  
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="./pvcfree_script_clean.js"></script>

</body>
</html>
