<script>
  // elementi UI
  const TBL = document.querySelector('#tbl tbody');
  const META = document.getElementById('meta');
  const BTN_RELOAD = document.getElementById('btn-reload');
  const BTN_EXPORT = document.getElementById('btn-export');

  // stato
  let DATA = [];

  // helpers
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function safeNum(x, def=""){ return x==null?def:String(x); }

  // normalizza un record Netlify Form (campi possono variare tra submission vecchie/nuove)
  function normalize(sub){
    const d = sub.data || {};
    return {
      created_at: sub.created_at || "",
      nome: d.nome || sub.name || "",
      cognome: d.cognome || "",
      azienda: d.azienda || "",
      email: d.email || sub.email || "",
      categoria: d.categoria || "",
      agente: d.agente || "",
      regione: d.regione || "",
      polimero: d.polimero || "",
      processo: d.processo || "",
      applicazione: d.applicazione || "",
      note: d.note || "",
      supabase_id: d.supabase_id || "",
      images_urls: d.supabase_image_urls || d.files || "",
    };
  }

  async function load(){
    META.textContent = "Carico…";
    TBL.innerHTML = "<tr><td colspan='8'>Caricamento…</td></tr>";

    try{
      const r = await fetch('/.netlify/functions/get-submissions', { headers: { 'Accept':'application/json' }});
      const ct = (r.headers.get('content-type') || '').toLowerCase();

      // se NON è JSON (es. 404 HTML), mostro errore leggibile
      if (!ct.includes('application/json')){
        const text = await r.text();
        throw new Error("Endpoint non JSON (probabile 404 delle Functions). Anteprima:\n" + text.slice(0,200));
      }

      const payload = await r.json();
      if (!r.ok) throw new Error(payload.error || 'Errore API');

      const subs = Array.isArray(payload.submissions) ? payload.submissions : [];
      DATA = subs.map(normalize);

      META.textContent = `${payload.form_name || 'contatti'} — ${DATA.length} voci`;
      render(DATA);
    }catch(err){
      console.error(err);
      META.textContent = "Errore: " + err.message;
      TBL.innerHTML = "<tr><td colspan='8'>Errore durante il caricamento. Apri la console per i dettagli.</td></tr>";
    }
  }

  function render(rows){
    TBL.innerHTML = "";
    rows.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(safeNum(s.created_at))}</td>
        <td>${escapeHtml(safeNum(s.nome))}</td>
        <td>${escapeHtml(safeNum(s.cognome))}</td>
        <td>${escapeHtml(safeNum(s.azienda))}</td>
        <td>${escapeHtml(safeNum(s.email))}</td>
        <td>${escapeHtml(safeNum(s.categoria))}</td>
        <td>${escapeHtml(safeNum(s.agente))}</td>
        <td title="${escapeHtml(s.note)}">${escapeHtml((s.note||"").slice(0,60))}${(s.note||"").length>60?"…":""}</td>
      `;
      TBL.appendChild(tr);
    });
  }

  function exportXLSX(){
    if (!DATA.length) { alert("Niente da esportare."); return; }
    const rows = DATA.map(s => ({
      "Creato il": s.created_at,
      "Nome": s.nome,
      "Cognome": s.cognome,
      "Azienda": s.azienda,
      "Email": s.email,
      "Categoria": s.categoria,
      "Agente": s.agente,
      "Regione": s.regione,
      "Polimero": s.polimero,
      "Processo": s.processo,
      "Applicazione": s.applicazione,
      "Note": s.note,
      "Supabase ID": s.supabase_id,
      "Immagini URL": s.images_urls
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Contatti");
    XLSX.writeFile(wb, "contatti.xlsx");
  }

  BTN_RELOAD && BTN_RELOAD.addEventListener('click', load);
  BTN_EXPORT && BTN_EXPORT.addEventListener('click', exportXLSX);

  // avvio
  load();
</script>
